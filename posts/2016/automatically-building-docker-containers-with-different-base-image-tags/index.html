<!DOCTYPE html>
<html lang="en">

<head>
  <title>
  Automatically Building Docker Containers With Different Base Image Tags · Steven Casagrande
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="Steven Casagrande">
<meta name="description" content="
  
    Warning
  
  This post was written in 2016 and the ecosystem has matured much since then.
Proceed with caution!


At work I recently added a Dockerfile to one of our accessory tools, and set it up with Jenkins to build on a nightly basis. This build occurs nightly as opposed to on new master commits to ensure that the resulting container always has the latest versions of all its dependencies (including node).">
<meta name="keywords" content="blog,developer,personal">
<meta name="fediverse:creator" content="" />


  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Automatically Building Docker Containers With Different Base Image Tags">
  <meta name="twitter:description" content="Warning This post was written in 2016 and the ecosystem has matured much since then.
Proceed with caution!
At work I recently added a Dockerfile to one of our accessory tools, and set it up with Jenkins to build on a nightly basis. This build occurs nightly as opposed to on new master commits to ensure that the resulting container always has the latest versions of all its dependencies (including node).">

<meta property="og:url" content="https://steven.casagrande.io/posts/2016/automatically-building-docker-containers-with-different-base-image-tags/">
  <meta property="og:site_name" content="Steven Casagrande">
  <meta property="og:title" content="Automatically Building Docker Containers With Different Base Image Tags">
  <meta property="og:description" content="Warning This post was written in 2016 and the ecosystem has matured much since then.
Proceed with caution!
At work I recently added a Dockerfile to one of our accessory tools, and set it up with Jenkins to build on a nightly basis. This build occurs nightly as opposed to on new master commits to ensure that the resulting container always has the latest versions of all its dependencies (including node).">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2016-04-20T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-09-07T00:00:00+00:00">
    <meta property="article:tag" content="Docker">
    <meta property="article:tag" content="Jenkins">
    <meta property="article:tag" content="Bash">




<link rel="canonical" href="https://steven.casagrande.io/posts/2016/automatically-building-docker-containers-with-different-base-image-tags/">


<link rel="preload" href="/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="/css/coder.min.07092c1350ffd254998dc43a44ae96e617d14af4df4602626878df89189c5e1a.css" integrity="sha256-BwksE1D/0lSZjcQ6RK6W5hfRSvTfRgJiaHjfiRicXho=" crossorigin="anonymous" media="screen" />






  
    
    
    <link rel="stylesheet" href="/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css" integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin="anonymous" media="screen" />
  



 




<link rel="icon" type="image/svg+xml" href="/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">









</head>






<body class="preload-transitions colorscheme-dark">
  

  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="https://steven.casagrande.io/">
      Steven Casagrande
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="/posts/">Posts</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/categories/bazel">Bazel</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/about/">About</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="https://steven.casagrande.io/posts/2016/automatically-building-docker-containers-with-different-base-image-tags/">
              Automatically Building Docker Containers With Different Base Image Tags
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2016-04-20T00:00:00Z">
                April 20, 2016
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              2-minute read
            </span>
          </div>
          
          
          <div class="tags">
  <i class="fa-solid fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="/tags/docker/">Docker</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/tags/jenkins/">Jenkins</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/tags/bash/">Bash</a>
    </span></div>

        </div>
      </header>

      <div class="post-content">
        
        <div class="notice warning">
  <div class="notice-title">
    <i class="fa-solid fa-exclamation-triangle" aria-hidden="true"></i>Warning
  </div>
  <div class="notice-content"><p>This post was written in 2016 and the ecosystem has matured much since then.</p>
<p>Proceed with caution!</p></div>
</div>

<p>At work I recently added a Dockerfile to one of our accessory tools, and set it up with Jenkins to build on a nightly basis. This build occurs nightly as opposed to on new master commits to ensure that the resulting container always has the latest versions of all its dependencies (including node).</p>
<p>I wrote the Dockerfile such that we were building off of the <a href="https://hub.docker.com/_/node"  class="external-link" target="_blank" rel="noopener">official node containers</a>. Specifically, off of the latest tag. Here is what I mean:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> node:latest</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> some-stuff<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>This would ensure that I was always using the latest node version every night, which is exactly what I wanted. Perfect!</p>
<p>A few weeks later as news of the container made its way around the devs, I was asked to provide a build of the tool that uses the latest LTS node release instead of the latest-latest release. I should be able to do that, no problem. On Docker Hub there is a node tag named <code>argon</code>, which corresponds to the latest build of the current LTS branch (currently node 4.4.3). So my challenge was to provide two identical containers with only the node version changed between them.</p>
<p>I first considered using the Docker <code>--build-arg</code> flag with a corresponding <code>ARG</code> line in the Dockerfile. Typically, this is used in the following way:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> ubuntu</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ARG</span> myvar<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> apt-get install <span style="color:#e6db74">${</span>myvar<span style="color:#e6db74">}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>And then built like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker build --build-arg myvar<span style="color:#f92672">=</span>value -t container-name .
</span></span></code></pre></div><p>But of course, I wanted to use this build argument in the <code>FROM</code> line. So first I tried this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">ARG</span> tag<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> node:${tag}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> some-stuff<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>But that isn&rsquo;t going to work. The first line in every Dockerfile must be a <code>FROM</code> statement.</p>
<p>What I instead decided to do (and settled on) was to instead use a file I named <code>Dockerfile-template</code>, and then use the unix tool <code>sed</code> to generate the actual Dockerfile one at a time. Here is what that looked like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> node:TAG</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> some-stuff<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>And the scrubbed bash script that was run by Jenkins:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>TAGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;latest:argon&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> tag in <span style="color:#e6db74">${</span>tags//:/ <span style="color:#e6db74">}</span>; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    sed <span style="color:#e6db74">&#39;s/TAG/&#39;</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>tag<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&#39;/&#39;</span> Dockerfile-template &gt; Dockerfile
</span></span><span style="display:flex;"><span>    docker build --no-cache -t container-name:<span style="color:#e6db74">${</span>tag<span style="color:#e6db74">}</span> .
</span></span><span style="display:flex;"><span>    docker push container-name:<span style="color:#e6db74">${</span>tag<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>    docker rmi container-name:<span style="color:#e6db74">${</span>tag<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span></code></pre></div><p>So now I&rsquo;m providing nightly rebuilds of the internal tool, one with tag <code>latest</code> and one with tag <code>argon</code>, each corresponding to what version of node it was built with!</p>

      </div>


      <footer>
        


        
        
        
        
        

        
        
      </footer>
    </article>

    
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ©
    
    2024
     Steven Casagrande 
    ·
    
    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js" integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
  

  

  


  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>

</html>
