<!DOCTYPE html>
<html lang="en">

<head>
  <title>
  Python, Requests, and SSL · Steven Casagrande
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="Steven Casagrande">
<meta name="description" content="
  
    Warning
  
  This post was written in 2016 when asyncio was the highlight feature in the recently released Python 3.5.
There are probably much better ways to handle this now. Proceed with caution!



  SSL and Synchronous Requests
  
    
    Link to heading
  

(scroll down for async requests)
In Python, the main way in which one makes a web request is via the requests library, like so:">
<meta name="keywords" content="blog,developer,personal">
<meta name="fediverse:creator" content="" />


  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Python, Requests, and SSL">
  <meta name="twitter:description" content=" Warning This post was written in 2016 when asyncio was the highlight feature in the recently released Python 3.5.
There are probably much better ways to handle this now. Proceed with caution!
SSL and Synchronous Requests Link to heading (scroll down for async requests)
In Python, the main way in which one makes a web request is via the requests library, like so:">

<meta property="og:url" content="https://steven.casagrande.io/posts/2016/python-requests-and-ssl/">
  <meta property="og:site_name" content="Steven Casagrande">
  <meta property="og:title" content="Python, Requests, and SSL">
  <meta property="og:description" content=" Warning This post was written in 2016 when asyncio was the highlight feature in the recently released Python 3.5.
There are probably much better ways to handle this now. Proceed with caution!
SSL and Synchronous Requests Link to heading (scroll down for async requests)
In Python, the main way in which one makes a web request is via the requests library, like so:">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2016-06-20T00:00:00+00:00">
    <meta property="article:modified_time" content="2016-06-20T00:00:00+00:00">
    <meta property="article:tag" content="Python">




<link rel="canonical" href="https://steven.casagrande.io/posts/2016/python-requests-and-ssl/">


<link rel="preload" href="/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="/css/coder.min.07092c1350ffd254998dc43a44ae96e617d14af4df4602626878df89189c5e1a.css" integrity="sha256-BwksE1D/0lSZjcQ6RK6W5hfRSvTfRgJiaHjfiRicXho=" crossorigin="anonymous" media="screen" />






  
    
    
    <link rel="stylesheet" href="/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css" integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin="anonymous" media="screen" />
  



 




<link rel="icon" type="image/svg+xml" href="/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">









</head>






<body class="preload-transitions colorscheme-dark">
  

  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="https://steven.casagrande.io/">
      Steven Casagrande
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="/posts/">Posts</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/categories/bazel">Bazel</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/about/">About</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="https://steven.casagrande.io/posts/2016/python-requests-and-ssl/">
              Python, Requests, and SSL
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2016-06-20T00:00:00Z">
                June 20, 2016
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              3-minute read
            </span>
          </div>
          
          
          <div class="tags">
  <i class="fa-solid fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="/tags/python/">Python</a>
    </span></div>

        </div>
      </header>

      <div class="post-content">
        
        <div class="notice warning">
  <div class="notice-title">
    <i class="fa-solid fa-exclamation-triangle" aria-hidden="true"></i>Warning
  </div>
  <div class="notice-content"><p>This post was written in 2016 when <code>asyncio</code> was the highlight feature in the recently released Python 3.5.</p>
<p>There are probably much better ways to handle this now. Proceed with caution!</p></div>
</div>

<h2 id="ssl-and-synchronous-requests">
  SSL and Synchronous Requests
  <a class="heading-link" href="#ssl-and-synchronous-requests">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>(scroll down for async requests)</p>
<p>In Python, the main way in which one makes a web request is via the <code>requests</code> library, like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span>r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;http://google.com&#34;</span>)
</span></span></code></pre></div><p>Where in this example Google&rsquo;s website is the route that you are interested in. Typically, this would be some API route that returns JSON-encoded data.</p>
<p>Alright, so lets say you&rsquo;re building something for work, and you&rsquo;d like to hit an internal-API which only accepts connections over HTTPS. Your first approach might be something like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span>r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;https://internalsite/api&#34;</span>)
</span></span></code></pre></div><p>But this is going to return a Stacktrace with this exception:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>requests.exceptions.SSLError: [Errno 1] _ssl.c:503: error:14090086:SSL routines:SSL3_GET_SERVER_CERTIFICATE:certificate verify failed
</span></span></code></pre></div><p>So what can we do here? Well, the easiest is just to disable SSL verfication:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span>r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;https://internalsite/api&#34;</span>, verify<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span></code></pre></div><p>But then you&rsquo;ll have to look at SSL disabled warnings every time you make a query, and who wants that?</p>
<p>Instead, what we want to do is specify our certificate bundle file location where we&rsquo;ve included our certificates for the internal sites we would like to access. There are a few ways to do this with the <code>requests</code> package.</p>
<ol>
<li>
<p>Define the environment variable <code>REQUESTS_CA_BUNDLE</code> which points to your certificate bundle file. For example: <code>/etc/ssl/certs/ca-certificates.crt</code>. When this variable has been defined, <code>requests</code> will use it as the default for all connections, and so you don&rsquo;t need to modify any of your code.</p>
</li>
<li>
<p>Fork package <a href="https://github.com/certifi/python-certifi"  class="external-link" target="_blank" rel="noopener"><code>certifi</code></a>,  add your internal root-CA certificate to this, and then install with <code>python setup.py install</code>. When <code>certifi</code> is present, <code>requests</code> will default to using it has the root-CA authority and will do SSL-verification against the certificates found there.</p>
</li>
<li>
<p>Modify your code to point to the certificate bundle file like so:</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span>r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;https://internalsite/api&#34;</span>, verify<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/etc/ssl/certs/ca-certificates.crt&#34;</span>)
</span></span></code></pre></div><h2 id="ssl-and-asynchronous-requests">
  SSL and Asynchronous Requests
  <a class="heading-link" href="#ssl-and-asynchronous-requests">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>So things are a little bit different with async requests under <code>asyncio</code> and <code>aiohttp</code>. Instead what we have to do here is create an SSL context with the <code>ssl</code> standard library, and pass that into the appropriate objects from <code>aiohttp</code>. Here is an example of this in action:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> aiohttp
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> ssl
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">foobar</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># The URLs and headers (blank in this demo) that will be requested async</span>
</span></span><span style="display:flex;"><span>    routes <span style="color:#f92672">=</span> [(<span style="color:#e6db74">&#34;https://internalsite/api/1&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>), (<span style="color:#e6db74">&#34;https://internalsite/api/2&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>)]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Create out SSL context object with our CA cert file</span>
</span></span><span style="display:flex;"><span>    sslcontext <span style="color:#f92672">=</span> ssl<span style="color:#f92672">.</span>create_default_context(cafile<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/etc/ssl/certs/ca-certificates.crt&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Pass this SSL context to aiohttp and create a TCPConnector</span>
</span></span><span style="display:flex;"><span>    conn <span style="color:#f92672">=</span> aiohttp<span style="color:#f92672">.</span>TCPConnector(ssl_context<span style="color:#f92672">=</span>sslcontext)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Using this TCPConnector, open a session</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> aiohttp<span style="color:#f92672">.</span>ClientSession(connector<span style="color:#f92672">=</span>conn) <span style="color:#66d9ef">as</span> client:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># This is the asyncio part</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Create a list of futures</span>
</span></span><span style="display:flex;"><span>        futures <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>            fetch_json(client, url<span style="color:#f92672">=</span>url, headers<span style="color:#f92672">=</span>headers)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> (url, headers) <span style="color:#f92672">in</span> routes
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Then wait for the futures to all complete</span>
</span></span><span style="display:flex;"><span>        content <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>get_event_loop()<span style="color:#f92672">.</span>run_until_complete(asyncio<span style="color:#f92672">.</span>wait(futures))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Extract the resulting data</span>
</span></span><span style="display:flex;"><span>        data <span style="color:#f92672">=</span> [item<span style="color:#f92672">.</span>result() <span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> content[<span style="color:#ae81ff">0</span>]]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fetch_json</span>(client, url, headers):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">with</span> client<span style="color:#f92672">.</span>get(url, headers<span style="color:#f92672">=</span>headers) <span style="color:#66d9ef">as</span> resp:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> resp<span style="color:#f92672">.</span>json()
</span></span></code></pre></td></tr></table>
</div>
</div><p>(Sidenote: I noticed in some of the discussion on the <code>requests</code> GitHub page that they would like the ability to take SSL context objects similar to <code>aiohttp</code> (as shown above) and the standard library <code>urllib</code>)</p>
<p>And that&rsquo;s what you need to do to get your SSL authentication all squared away!</p>

      </div>


      <footer>
        


        
        
        
        
        

        
        
      </footer>
    </article>

    
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ©
    
    2024
     Steven Casagrande 
    ·
    
    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js" integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
  

  

  


  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>

</html>
