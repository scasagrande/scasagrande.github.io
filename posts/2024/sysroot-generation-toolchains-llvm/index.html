<!DOCTYPE html>
<html lang="en">

<head>
  <title>
  Sysroot package generation for use with toolchains_llvm · Steven Casagrande
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="Steven Casagrande">
<meta name="description" content="How to generate a sysroot package for use with the Bazel ruleset [`toolchains_llvm`][toolchains_llvm] in order to utilize a hermetic llvm-clang C/C&#43;&#43; compiler toolchain.">
<meta name="keywords" content="blog,developer,personal">
<meta name="fediverse:creator" content="" />


  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Sysroot package generation for use with toolchains_llvm">
  <meta name="twitter:description" content="How to generate a sysroot package for use with the Bazel ruleset [`toolchains_llvm`][toolchains_llvm] in order to utilize a hermetic llvm-clang C/C&#43;&#43; compiler toolchain.">

<meta property="og:url" content="https://steven.casagrande.io/posts/2024/sysroot-generation-toolchains-llvm/">
  <meta property="og:site_name" content="Steven Casagrande">
  <meta property="og:title" content="Sysroot package generation for use with toolchains_llvm">
  <meta property="og:description" content="How to generate a sysroot package for use with the Bazel ruleset [`toolchains_llvm`][toolchains_llvm] in order to utilize a hermetic llvm-clang C/C&#43;&#43; compiler toolchain.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-03-23T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-09-08T00:00:00+00:00">
    <meta property="article:tag" content="Bazel">
    <meta property="article:tag" content="Sysroot">
    <meta property="article:tag" content="Toolchains_llvm">




<link rel="canonical" href="https://steven.casagrande.io/posts/2024/sysroot-generation-toolchains-llvm/">


<link rel="preload" href="/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="/css/coder.min.07092c1350ffd254998dc43a44ae96e617d14af4df4602626878df89189c5e1a.css" integrity="sha256-BwksE1D/0lSZjcQ6RK6W5hfRSvTfRgJiaHjfiRicXho=" crossorigin="anonymous" media="screen" />






  
    
    
    <link rel="stylesheet" href="/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css" integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin="anonymous" media="screen" />
  



 




<link rel="icon" type="image/svg+xml" href="/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">









</head>






<body class="preload-transitions colorscheme-dark">
  

  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="https://steven.casagrande.io/">
      Steven Casagrande
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="/posts/">Posts</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/categories/bazel">Bazel</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/about/">About</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="https://steven.casagrande.io/posts/2024/sysroot-generation-toolchains-llvm/">
              Sysroot package generation for use with toolchains_llvm
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2024-03-23T00:00:00Z">
                March 23, 2024
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              7-minute read
            </span>
          </div>
          
          <div class="categories">
  <i class="fa-solid fa-folder" aria-hidden="true"></i>
    <a href="/categories/bazel/">Bazel</a></div>

          <div class="tags">
  <i class="fa-solid fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="/tags/bazel/">Bazel</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/tags/sysroot/">Sysroot</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/tags/toolchains_llvm/">Toolchains_llvm</a>
    </span></div>

        </div>
      </header>

      <div class="post-content">
        
        <p><a href="https://bazel.build/"  class="external-link" target="_blank" rel="noopener">Bazel</a> aims to provide a hermetic environment for your build &amp; test operations (&ldquo;actions&rdquo;) to run in. However by default Bazel does not provide a hermetic C / C++ (CC) toolchain. If you would like to learn more about this and why it is important, then I suggest you read <a href="https://blog.aspect.dev/hermetic-c-toolchain"  class="external-link" target="_blank" rel="noopener">this article by Thulio Ferraz Assis at Aspect</a>.</p>
<p>Alongside their article, <a href="https://github.com/f0rmiga/gcc-toolchain"  class="external-link" target="_blank" rel="noopener">they developed a solution</a> to enable a hermetic GCC compiler and associated Linux sysroot package. Their solution is great if you want to use GCC. But if you instead want to use a hermetic <code>llvm-clang</code> compiler toolchain, then we are going to have to make some modifications.</p>
<p>By the end of this article you will be able to generate your own Linux sysroot package and combine it together with <code>llvm-clang</code> in order to provide a hermetic CC toolchain capable of cross-compilation.</p>
<p>Link to source code: <a href="https://github.com/scasagrande/toolchains_llvm_sysroot"  class="external-link" target="_blank" rel="noopener">https://github.com/scasagrande/toolchains_llvm_sysroot</a></p>
<p>Please leave your questions and comments <a href="https://github.com/scasagrande/toolchains_llvm_sysroot/discussions/1"  class="external-link" target="_blank" rel="noopener">under the discussions tab on the repository</a>.</p>
<div class="notice info">
  <div class="notice-title">
    <i class="fa-solid fa-exclamation-circle" aria-hidden="true"></i>Info
  </div>
  <div class="notice-content">2024-09-07: Updated to emphasize the <code>bzlmod</code> workflow over the legacy <code>WORKSPACE</code> one.</div>
</div>

<h1 id="toolchains_llvm-ruleset">
  toolchains_llvm ruleset
  <a class="heading-link" href="#toolchains_llvm-ruleset">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>To start with, we are going to use the <a href="https://github.com/bazel-contrib/toolchains_llvm"  class="external-link" target="_blank" rel="noopener"><code>toolchains_llvm</code></a> ruleset in order to fetch and setup the actual toolchain. This ruleset allows you to <a href="https://github.com/bazel-contrib/toolchains_llvm?tab=readme-ov-file#sysroots"  class="external-link" target="_blank" rel="noopener">specify a Bazel target that contains your sysroot package files</a>.</p>
<p>Before we set it up, you&rsquo;ll need to choose if you&rsquo;re going to use <code>llvm-libc++</code> or if you are going to use <code>libstdc++</code>. The former is the default for the ruleset (when doing native compilation builds), it is the common libc++ implementation for macOS builds, and is included as part of the <a href="https://github.com/llvm/llvm-project/releases"  class="external-link" target="_blank" rel="noopener">standard llvm packages</a>. The latter, <code>libstdc++</code>, is more common for Linux builds. In both cases we will still require a separate sysroot package in order to provide a hermetic CC toolchain environment. Here I will be using <code>libstdc++</code> for our Linux target platform builds, and <code>libc++</code> for our macOS target platform builds.</p>
<p>Without a sysroot package, you might use this ruleset to define your CC toolchain as follows. This will enable a CC toolchain for Linux and macOS on both x86_64/amd64 and aarch64/arm64.</p>
<div class="notice example">
  <div class="notice-title">
    <i class="fa-solid fa-file-text" aria-hidden="true"></i>Example
  </div>
  <div class="notice-content"><code>llvm</code> version <code>15.0.2</code> was chosen for this example because <a href="https://github.com/llvm/llvm-project/releases/tag/llvmorg-15.0.2"  class="external-link" target="_blank" rel="noopener">there exists release packages</a> for all four of our build platform configurations. Choose whatever versions suit your needs. However, I suggest that you ultimately build your own copies and host the packages yourselves.</div>
</div>

<p><code>MODULE.bazel</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bzl" data-lang="bzl"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>bazel_dep(name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;toolchains_llvm&#34;</span>, version <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;1.1.2&#34;</span>, dev_dependency <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span><span style="color:#75715e"># Configure and register the toolchain.</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>llvm <span style="color:#f92672">=</span> use_extension(<span style="color:#e6db74">&#34;@toolchains_llvm//toolchain/extensions:llvm.bzl&#34;</span>, <span style="color:#e6db74">&#34;llvm&#34;</span>, dev_dependency <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>llvm<span style="color:#f92672">.</span>toolchain(
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>    name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;llvm_toolchain&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>    llvm_version <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;15.0.2&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>    stdlib <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>        <span style="color:#e6db74">&#34;linux-x86_64&#34;</span>: <span style="color:#e6db74">&#34;stdc++&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>        <span style="color:#e6db74">&#34;linux-aarch64&#34;</span>: <span style="color:#e6db74">&#34;stdc++&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>    }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>use_repo(llvm, <span style="color:#e6db74">&#34;llvm_toolchain&#34;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>register_toolchains(<span style="color:#e6db74">&#34;@llvm_toolchain//:all&#34;</span>, dev_dependency <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><p>or for projects using the legacy <code>WORKSPACE</code> system:</p>
<p><code>WORKSPACE.bazel</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bzl" data-lang="bzl"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>load(<span style="color:#e6db74">&#34;@bazel_tools//tools/build_defs/repo:http.bzl&#34;</span>, <span style="color:#e6db74">&#34;http_archive&#34;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>http_archive(
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>    name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;toolchains_llvm&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>    sha256 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;e91c4361f99011a54814e1afbe5c436e0d329871146a3cd58c23a2b4afb50737&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>    strip_prefix <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;toolchains_llvm-1.0.0&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>    url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://github.com/bazel-contrib/toolchains_llvm/releases/download/1.0.0/toolchains_llvm-1.0.0.tar.gz&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>load(<span style="color:#e6db74">&#34;@toolchains_llvm//toolchain:deps.bzl&#34;</span>, <span style="color:#e6db74">&#34;bazel_toolchain_dependencies&#34;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>bazel_toolchain_dependencies()
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>load(<span style="color:#e6db74">&#34;@toolchains_llvm//toolchain:rules.bzl&#34;</span>, <span style="color:#e6db74">&#34;llvm_toolchain&#34;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>llvm_toolchain(
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>    name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;llvm_toolchain&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>    llvm_version <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;15.0.2&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>    stdlib <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>        <span style="color:#e6db74">&#34;linux-x86_64&#34;</span>: <span style="color:#e6db74">&#34;stdc++&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>        <span style="color:#e6db74">&#34;linux-aarch64&#34;</span>: <span style="color:#e6db74">&#34;stdc++&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>    }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>load(<span style="color:#e6db74">&#34;@llvm_toolchain//:toolchains.bzl&#34;</span>, <span style="color:#e6db74">&#34;llvm_register_toolchains&#34;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>llvm_register_toolchains()
</span></span></code></pre></div><h1 id="sysroot-package-generation">
  Sysroot package generation
  <a class="heading-link" href="#sysroot-package-generation">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>Link to source code: <a href="https://github.com/scasagrande/toolchains_llvm_sysroot"  class="external-link" target="_blank" rel="noopener">https://github.com/scasagrande/toolchains_llvm_sysroot</a></p>
<p>Now we need to provide a sysroot package in order to ensure that the build is using a consistent version of our system libraries. As a bonus, we will generate a matching package for both <code>x86_64</code> and <code>aarch64</code> CPU architectures.</p>
<p>To programmatically construct these packages, I started with the <a href="https://github.com/f0rmiga/gcc-toolchain/tree/main/sysroot"  class="external-link" target="_blank" rel="noopener">sysroot generation code in the gcc-toolchain repo</a>. Although it&rsquo;s designed to build a sysroot package for that specific toolchain ruleset, we can modify it to meet the needs of <a href="https://github.com/bazel-contrib/toolchains_llvm"  class="external-link" target="_blank" rel="noopener"><code>toolchains_llvm</code></a>. It&rsquo;s also already set up to enable the generation of sysroot packages for both <code>x86_64</code> and <code>aarch64</code>.</p>
<p>With this starting point, I made the following changes:</p>
<ul>
<li>Updated the following system libraries to target a Red Hat Enterprise Linux (RHEL) 8 environment
<ul>
<li>Kernel 4.18</li>
<li>glibc 2.28</li>
<li>libstdc++ 10.3</li>
</ul>
</li>
<li>Updated toolchains used to versions that support building those above libraries</li>
<li>Removed a bunch of the files that we aren&rsquo;t going to need, such as binaries</li>
<li>Moved the files around, renamed some folders, and placed everything under a standard <code>/usr</code> layout</li>
</ul>
<p>With these changes, you&rsquo;ll have the basics that you need to provide a hermetic CC toolchain to Bazel.</p>
<p>In my case, I also decided to expand the sysroot package with <code>openssl</code> and <code>cyrus-sasl</code>, copied from a <a href="https://catalog.redhat.com/software/containers/ubi8/5c647760bed8bd28d0e38f9f"  class="external-link" target="_blank" rel="noopener">RHEL-UBI 8 container image</a>. Openssl is a very common build dependency and is useful to have in your sysroot. For those of us targeting a RHEL 8 production environment, it can be very helpful to have this specific copy of openssl for FIPS compliance. But we&rsquo;re not going to get into that today, and instead just focus on the fact that we are including these optional libraries in our sysroot package.</p>
<div class="notice note">
  <div class="notice-title">
    <i class="fa-solid fa-sticky-note" aria-hidden="true"></i>Note
  </div>
  <div class="notice-content">If your deliverable is an OCI image, you should not be shipping these libraries into your final artifacts. These are just to ensure that they are hermetically available for any Bazel build and test operations, and that we are dynamically linking against these production-like copies. Your base image should already have the exact versions that you need. You may even have regulation compliance requirements where you must use the copies already present in your base image. If you think that this may apply to you, be sure to consult the rest of your team!</div>
</div>

<p>So now lets go ahead and build it. These commands will build our two sysroot packages with these extra ssl libraries bundled in, and output them into our current directory.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>$ ./build.sh x86_64 . ssl
</span></span><span style="display:flex;"><span>$ ./build.sh aarch64 . ssl
</span></span></code></pre></div><p>If you want to omit these ssl related packages, then replace <code>ssl</code> with <code>base</code>.</p>
<p>After some processing time, you will be left with 2 <code>tar.xz</code> files. If you have been following along, the <code>x86_64</code> file should be approximately 55MB, and the <code>aarch64</code> file approximately 35MB.</p>
<h1 id="using-the-sysroot-package">
  Using the sysroot package
  <a class="heading-link" href="#using-the-sysroot-package">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>First we need to make the <code>tar.xz</code> files available to Bazel. You&rsquo;ll need to make your sysroot package available somewhere for your team to download, such as in <a href="https://jfrog.com/artifactory/"  class="external-link" target="_blank" rel="noopener">Artifactory</a>. How you do that is up to you. For testing, you can put in a fake URL and use the <code>--override_repository=</code> CLI argument built into Bazel.</p>
<p><code>MODULE.bazel</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bzl" data-lang="bzl"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>http_archive <span style="color:#f92672">=</span> use_repo_rule(<span style="color:#e6db74">&#34;@bazel_tools//tools/build_defs/repo:http.bzl&#34;</span>, <span style="color:#e6db74">&#34;http_archive&#34;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>http_archive(
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>    name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;sysroot_linux_x86_64_2_28&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>    url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://example.com/sysroot-x86_64-ssl.tar.xz&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>    sha256 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ABCD1234&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>    build_file <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;//external:BUILD.sysroot.bazel&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>http_archive(
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>    name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;sysroot_linux_aarch64_2_28&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>    url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://example.com/sysroot-aarch64-ssl.tar.xz&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>    sha256 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;1234ABCD&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>    build_file <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;//external:BUILD.sysroot.bazel&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>)
</span></span></code></pre></div><p><code>WORKSPACE.bazel</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bzl" data-lang="bzl"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>load(<span style="color:#e6db74">&#34;@bazel_tools//tools/build_defs/repo:http.bzl&#34;</span>, <span style="color:#e6db74">&#34;http_archive&#34;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>http_archive(
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>    name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;sysroot_linux_x86_64_2_28&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>    url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://example.com/sysroot-x86_64-ssl.tar.xz&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>    sha256 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ABCD1234&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>    build_file <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;//external:BUILD.sysroot.bazel&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>http_archive(
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>    name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;sysroot_linux_aarch64_2_28&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>    url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://example.com/sysroot-aarch64-ssl.tar.xz&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>    sha256 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;1234ABCD&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>    build_file <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;//external:BUILD.sysroot.bazel&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>)
</span></span></code></pre></div><p><code>external/BUILD.sysroot.bazel</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bzl" data-lang="bzl"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>filegroup(
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>    name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;sysroot&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>    srcs <span style="color:#f92672">=</span> glob([<span style="color:#e6db74">&#34;**&#34;</span>]),
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>    visibility <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;//visibility:public&#34;</span>]
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>)
</span></span></code></pre></div><p>And then we just need to update our toolchain definition to use these new sysroot package when building and targeting linux <code>x86_64</code> and <code>aarch64</code>.</p>
<p><code>MODULE.bazel</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-bzl" data-lang="bzl"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>bazel_dep(name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;toolchains_llvm&#34;</span>, version <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;1.1.2&#34;</span>, dev_dependency <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>llvm <span style="color:#f92672">=</span> use_extension(<span style="color:#e6db74">&#34;@toolchains_llvm//toolchain/extensions:llvm.bzl&#34;</span>, <span style="color:#e6db74">&#34;llvm&#34;</span>, dev_dependency <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>llvm<span style="color:#f92672">.</span>toolchain(
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>    llvm_version <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;15.0.2&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>    stdlib <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>        <span style="color:#e6db74">&#34;linux-x86_64&#34;</span>: <span style="color:#e6db74">&#34;stdc++&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>        <span style="color:#e6db74">&#34;linux-aarch64&#34;</span>: <span style="color:#e6db74">&#34;stdc++&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>    },
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>)
</span></span><span style="display:flex; background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>llvm<span style="color:#f92672">.</span>sysroot(
</span></span><span style="display:flex; background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>    name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;llvm_toolchain&#34;</span>,
</span></span><span style="display:flex; background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>    label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;@@sysroot_linux_x86_64_2_28//:sysroot&#34;</span>,
</span></span><span style="display:flex; background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>    targets <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;linux-x86_64&#34;</span>],
</span></span><span style="display:flex; background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>)
</span></span><span style="display:flex; background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>llvm<span style="color:#f92672">.</span>sysroot(
</span></span><span style="display:flex; background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>    name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;llvm_toolchain&#34;</span>,
</span></span><span style="display:flex; background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>    label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;@@sysroot_linux_aarch64_2_28//:sysroot&#34;</span>,
</span></span><span style="display:flex; background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>    targets <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;linux-aarch64&#34;</span>],
</span></span><span style="display:flex; background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>use_repo(llvm, <span style="color:#e6db74">&#34;llvm_toolchain&#34;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>register_toolchains(<span style="color:#e6db74">&#34;@llvm_toolchain//:all&#34;</span>, dev_dependency <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><p><code>WORKSPACE.bazel</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-bzl" data-lang="bzl"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span>llvm_toolchain(
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>    name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;llvm_toolchain&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>    llvm_version <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;15.0.2&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>    stdlib <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>        <span style="color:#e6db74">&#34;linux-x86_64&#34;</span>: <span style="color:#e6db74">&#34;stdc++&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>        <span style="color:#e6db74">&#34;linux-aarch64&#34;</span>: <span style="color:#e6db74">&#34;stdc++&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>    }
</span></span><span style="display:flex; background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>    sysroot <span style="color:#f92672">=</span> {
</span></span><span style="display:flex; background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>        <span style="color:#e6db74">&#34;linux-x86_64&#34;</span>: <span style="color:#e6db74">&#34;@sysroot_linux_x86_64_2_28//:sysroot&#34;</span>,
</span></span><span style="display:flex; background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>        <span style="color:#e6db74">&#34;linux-aarch64&#34;</span>: <span style="color:#e6db74">&#34;@sysroot_linux_aarch64_2_28//:sysroot&#34;</span>,
</span></span><span style="display:flex; background-color:#3c3d38"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>    }
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>)
</span></span></code></pre></div><p>Optionally, we can test our build without having uploaded the <code>tar.xz</code>. Start with unpacking the tar file into a folder on your filesystem. Next make a <code>BUILD.bazel</code> file located at the root of this extracted folder (that is, beside the extracted <code>usr/</code> folder) with the contents from your <code>BUILD.sysroot.bazel</code> file.</p>
<p>Finally, to execute your test, run the following if you are building on a Linux x86_64 machine:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>$ bazel build --override_repository<span style="color:#f92672">=</span>sysroot_linux_x86_64_2_28<span style="color:#f92672">=</span>/path/to/sysroot-x86_64-ssl //...
</span></span></code></pre></div><h1 id="result">
  Result
  <a class="heading-link" href="#result">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>In the end you should now be able to build and test targeting linux <code>x86_64</code> or <code>aarch64</code>, both with native builds or cross compilation, including from macOS!</p>
<p>But does that mean that you now have a fully hermetic CC build? Well, that is going to depend on the rest of your project. For example, if you have rust dependencies fetched via <a href="https://github.com/bazelbuild/rules_rust"  class="external-link" target="_blank" rel="noopener"><code>rules_rust</code></a> , some of them may include <code>build.rs</code> files that perform their own CC compilation that breaks out of the Bazel sandbox, such as <a href="https://github.com/onsails/rust-rdkafka/blob/master/rdkafka-sys/build.rs"  class="external-link" target="_blank" rel="noopener"><code>rdkafka-sys</code></a>, <a href="https://github.com/sfackler/rust-openssl/blob/master/openssl-sys/build/main.rs"  class="external-link" target="_blank" rel="noopener"><code>openssl-sys</code></a>, or <a href="https://github.com/MaterializeInc/rust-sasl/blob/master/sasl2-sys/build.rs"  class="external-link" target="_blank" rel="noopener"><code>sasl2-sys</code></a>. In the future I will cover how best to deal with these cases, while also using our new sysroot packages.</p>
<h1 id="feedback">
  Feedback
  <a class="heading-link" href="#feedback">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>Please leave your questions and comments <a href="https://github.com/scasagrande/toolchains_llvm_sysroot/discussions/1"  class="external-link" target="_blank" rel="noopener">in this discussions thread on the repository</a>.</p>
<p>I can also be reached on the <a href="https://bazelbuild.slack.com"  class="external-link" target="_blank" rel="noopener">Bazel slack community</a> under my full name.</p>

      </div>


      <footer>
        


        
        
        
        
        

        
        
      </footer>
    </article>

    
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ©
    
    2025
     Steven Casagrande 
    ·
    
    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js" integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
  

  

  


  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>

</html>
