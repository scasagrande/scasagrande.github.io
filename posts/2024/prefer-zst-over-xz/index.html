<!DOCTYPE html>
<html lang="en">

<head>
  <title>
  Prefer ZST compression over XZ for use with Bazel · Steven Casagrande
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="Steven Casagrande">
<meta name="description" content="Earlier this year, I was profiling our Bazel builds looking for any easy wins to speed up CI. One bottleneck I found was the decompression of fetched archives that were compressed with xz.
Before starting this work I already knew that decompressing our pre-built llvm toolchain and sysroot package took a non-trivial amount of time. But with the full profiling data in hand I was able to see exactly how much time we were spending in CI on fetch vs decompression, how many tasks were waiting, and if there were any other decompression tasks taking a non-trivial amount of time.">
<meta name="keywords" content="blog,developer,personal">
<meta name="fediverse:creator" content="" />


  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Prefer ZST compression over XZ for use with Bazel">
  <meta name="twitter:description" content="Earlier this year, I was profiling our Bazel builds looking for any easy wins to speed up CI. One bottleneck I found was the decompression of fetched archives that were compressed with xz.
Before starting this work I already knew that decompressing our pre-built llvm toolchain and sysroot package took a non-trivial amount of time. But with the full profiling data in hand I was able to see exactly how much time we were spending in CI on fetch vs decompression, how many tasks were waiting, and if there were any other decompression tasks taking a non-trivial amount of time.">

<meta property="og:url" content="https://steven.casagrande.io/posts/2024/prefer-zst-over-xz/">
  <meta property="og:site_name" content="Steven Casagrande">
  <meta property="og:title" content="Prefer ZST compression over XZ for use with Bazel">
  <meta property="og:description" content="Earlier this year, I was profiling our Bazel builds looking for any easy wins to speed up CI. One bottleneck I found was the decompression of fetched archives that were compressed with xz.
Before starting this work I already knew that decompressing our pre-built llvm toolchain and sysroot package took a non-trivial amount of time. But with the full profiling data in hand I was able to see exactly how much time we were spending in CI on fetch vs decompression, how many tasks were waiting, and if there were any other decompression tasks taking a non-trivial amount of time.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-12-16T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-12-16T00:00:00+00:00">
    <meta property="article:tag" content="Zst">
    <meta property="article:tag" content="Xz">
    <meta property="article:tag" content="Compression">




<link rel="canonical" href="https://steven.casagrande.io/posts/2024/prefer-zst-over-xz/">


<link rel="preload" href="/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="/css/coder.min.07092c1350ffd254998dc43a44ae96e617d14af4df4602626878df89189c5e1a.css" integrity="sha256-BwksE1D/0lSZjcQ6RK6W5hfRSvTfRgJiaHjfiRicXho=" crossorigin="anonymous" media="screen" />






  
    
    
    <link rel="stylesheet" href="/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css" integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin="anonymous" media="screen" />
  



 




<link rel="icon" type="image/svg+xml" href="/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">









</head>






<body class="preload-transitions colorscheme-dark">
  

  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="https://steven.casagrande.io/">
      Steven Casagrande
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="/posts/">Posts</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/categories/bazel">Bazel</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/about/">About</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="https://steven.casagrande.io/posts/2024/prefer-zst-over-xz/">
              Prefer ZST compression over XZ for use with Bazel
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2024-12-16T00:00:00Z">
                December 16, 2024
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              3-minute read
            </span>
          </div>
          
          <div class="categories">
  <i class="fa-solid fa-folder" aria-hidden="true"></i>
    <a href="/categories/bazel/">Bazel</a></div>

          <div class="tags">
  <i class="fa-solid fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="/tags/zst/">Zst</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/tags/xz/">Xz</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/tags/compression/">Compression</a>
    </span></div>

        </div>
      </header>

      <div class="post-content">
        
        <p>Earlier this year, I was profiling our Bazel builds looking for any easy wins to speed up CI. One bottleneck I found was the decompression of fetched archives that were compressed with xz.</p>
<p>Before starting this work I already knew that decompressing our <a href="/posts/2024/building-macos-llvm-package/" >pre-built llvm toolchain</a> and <a href="/posts/2024/sysroot-generation-toolchains-llvm/" >sysroot package</a> took a non-trivial amount of time. But with the full profiling data in hand I was able to see exactly how much time we were spending in CI on fetch vs decompression, how many tasks were waiting, and if there were any other decompression tasks taking a non-trivial amount of time.</p>
<p>After doing some research online, I decided to experiment with ZST compression instead of XZ. I already knew that XZ had poor decompression speeds, especially at higher compression levels, so it was worth taking a look.</p>
<h2 id="repacking-llvm-toolchain-with-zst-compression">
  Repacking llvm toolchain with ZST compression
  <a class="heading-link" href="#repacking-llvm-toolchain-with-zst-compression">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>Using my Macbook Pro equipped with an M3-Pro, I started with fetching my macos-arm llvm toolchain, decompressed it, and then switched it to ZST as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Install pre-reqs, using gnu-tar to prevent any warnings caused by gnu-tar </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># decompressing archives built with macOS bundled bsd-tar. This is optional, </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># you can use `tar` if you like. </span>
</span></span><span style="display:flex;"><span>brew install gnu-tar zstd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Time decompression for XZ archive</span>
</span></span><span style="display:flex;"><span>time gtar xf clang-17.0.6-aarch64-apple-darwin.tar.xz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create new ZST compressed archive with maximum compression</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># This will take a while!</span>
</span></span><span style="display:flex;"><span>gtar cf clang-17.0.6-aarch64-apple-darwin.tar bin include lib
</span></span><span style="display:flex;"><span>zstd --ultra -T0 -22 clang-17.0.6-aarch64-apple-darwin.tar 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Remove old folders</span>
</span></span><span style="display:flex;"><span>rm -r bin include lib
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Time decompression of ZST archive</span>
</span></span><span style="display:flex;"><span>time gtar xf clang-17.0.6-aarch64-apple-darwin.tar.zst 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Check filesize of both archives</span>
</span></span><span style="display:flex;"><span>du -h clang-17.0.6-aarch64-apple-darwin.tar.<span style="color:#f92672">{</span>zst,xz<span style="color:#f92672">}</span> 
</span></span></code></pre></div><p>The decompression speeds were much faster than I had hoped. The XZ package took 5.45s while the ZST package was only 0.66s!</p>
<p>Now the part that surprised me was the filesize. I expected that the ZST archives would be larger. However, this resulted in a filesize of 122MB for XZ and 101MB for ZST. So smaller and faster to decompress! A win-win for my purposes here.</p>
<h2 id="results-of-re-bundling-all-4-platform-toolchains">
  Results of re-bundling all 4 platform toolchains
  <a class="heading-link" href="#results-of-re-bundling-all-4-platform-toolchains">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>With these great local results, I went ahead and re-bundled all 4 llvm packages, with the following results. All data was taken as a single shot on my Macbook Pro with M3-Pro processor. You are welcome to complain about significant figures.</p>
<table>
  <thead>
      <tr>
          <th>Platform</th>
          <th>File size XZ (MB)</th>
          <th>File size ZST (MB)</th>
          <th>Decompression time XZ (s)</th>
          <th>Decompression time ZST (s)</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Linux x86</td>
          <td>98</td>
          <td>66</td>
          <td>4.51</td>
          <td>0.42</td>
      </tr>
      <tr>
          <td>Linux arm</td>
          <td>87</td>
          <td>61</td>
          <td>3.80</td>
          <td>0.40</td>
      </tr>
      <tr>
          <td>macOS x86</td>
          <td>117</td>
          <td>85</td>
          <td>5.29</td>
          <td>0.61</td>
      </tr>
      <tr>
          <td>macOS arm</td>
          <td>122</td>
          <td>101</td>
          <td>5.45</td>
          <td>0.66</td>
      </tr>
  </tbody>
</table>
<p>All 4 packages are smaller and have 9-10x faster decompression speeds!</p>
<p>A couple of seconds might not seem like much, but:</p>
<ul>
<li>My CI workers are slower than my Macbook</li>
<li>This happens on every single CI job because I am restricted to ephemeral workers</li>
<li>Setting up the C++ toolchain is a blocker for most of the build</li>
</ul>
<p>After profiling this in CI, I was able to verify an improvement in the extraction time from 18s down to 2s, which is inline with the speedup that I saw locally.</p>
<p>Coupling this with migrating the sysroot packages to ZST compression, together they helped save approximately 30sec at the start of every single build.</p>
<h1 id="feedback">
  Feedback
  <a class="heading-link" href="#feedback">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>I can be reached on the <a href="https://bazelbuild.slack.com"  class="external-link" target="_blank" rel="noopener">Bazel slack community</a> under my full name.</p>

      </div>


      <footer>
        


        
        
        
        
        

        
        
      </footer>
    </article>

    
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ©
    
    2025
     Steven Casagrande 
    ·
    
    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js" integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
  

  

  


  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>

</html>
